
---

## 2. `ErrorCodes.md`

```markdown
# Error Codes for TS-1388 Parser

Данный документ описывает коды ошибок, используемые в парсере TS-1388.  
Каждая функция парсинга P_XXX при завершении должна вернуть один из этих кодов и установить ParamErrorCode(i).

---

## 255 — OK

**Описание:**  
Параметр успешно обработан.

**Варианты:**
- обязательный параметр найден, проверен, заменён токеном;
- опциональный параметр не найден, но это разрешено логикой (например, значение `-` или полностью отсутствует), и функция считает такой случай штатным.

---

## 1 — PARAM_NOT_FOUND

**Описание:**  
Параметр не найден там, где он ожидается.

**Типичные случаи:**
- в соответствующем сегменте строки вместо значения — нечто иное;
- выражение не соответствует допустимому шаблону;
- сегмент содержит только `-` при условии, что параметр обязателен.

**Действия:**
- `ParamStart(i) = 0`
- `ParamEnd(i) = 0`
- `ParamValue(i) = ""`
- `ParamErrorCode(i) = 1`

---

## 2 — MALFORMED_VALUE

**Описание:**  
Параметр найден, но его значение синтаксически некорректно или не соответствует правилам.

**Примеры:**
- диапазон температур: `-6O...+200` (буква O вместо цифры 0);
- диапазон: `+200...-50` (перепутаны местами LOW и HIGH);
- длина `10--->9` (некорректное обозначение, если оно не разрешено ТЗ);
- исполнение `BG2` без корректного префикса A/EX/АВ/EXВ и т.п.;
- неизвестный тип датчика, не входящий в список поддерживаемых (например, `PT999`).

**Действия:**
- ParamStart/ParamEnd указывают на проблемный фрагмент;
- ParamValue(i) содержит исходное значение;
- ParamErrorCode(i) = 2.

---

## 3 — ERR_FOUND_NOT_CLEANED

**Описание:**  
Параметр найден и распознан, но исходный фрагмент не заменён токеном в WorkString.

Используется как служебная ошибка для контроля функции `ReplaceParam`.

**Условия:**
- `ParamStart(i) > 0`
- `ParamEnd(i) > 0`
- `ParamValue(i) <> ""`
- но в WorkString фрагмент исходного текста всё ещё присутствует (или токен установлен некорректно).

**Назначение:**
- поиск несоответствий между логикой поиска и логикой замены;
- проверка корректности всех вызовов ReplaceParam.

---

## 4 — RANGE_ERROR

**Описание:**  
Числовое значение параметра находится вне допустимого диапазона.

**Примеры:**
- P_T_LOW < -200 или > P_T_HIGH;
- P_T_HIGH > +1000;
- толщина стенки ≤ 0;
- длина ≤ 0 или больше максимально допустимой (например, > 5000 мм, если такое ограничение задано ТЗ).

**Действия:**
- ParamValue(i) сохраняет исходное значение;
- ParamErrorCode(i) = 4.

---

## 5 — OVERLAP_ERROR

**Описание:**  
Границы параметров пересекаются, что говорит о некорректной разметке WorkString.

**Примеры:**
- P_MODEL захватил часть следующего сегмента;
- P_EX захватил одновременно куски двух соседних сегментов.

**Использование:**
- чаще всего выставляется в функции финальной валидации, когда по всем ParamStart/ParamEnd проверяется отсутствие пересечений.

---

## 6 — TOKEN_CONFLICT

**Описание:**
Обнаружена проблема с токенами:

- два разных параметра используют один и тот же номер токена;
- токен в WorkString не соответствует ожидаемому формату `#<n>_<ParamValue(i)>%`;
- токен расположен в месте, где должен быть другой параметр.

**Использование:**
- полезно при отладке ReplaceParam и общей схемы токенизации.

---

## 7 — NORMALIZE_ERROR

**Описание:**  
Ошибка на этапе нормализации строки:

- строка после нормализации оказалась пустой;
- обнаружены недопустимые символы, которые невозможно корректно обработать;
- процесс нормализации завершился с внутренней ошибкой (например, в RegExp).

---

## 127 — UNKNOWN_FRAGMENT

**Описание:**  
После выполнения всех функций P_XXX в WorkString остались фрагменты текста, которые:

- не являются токенами,
- не являются допустимыми разделителями,
- не описаны в Grammar.md.

**Назначение:**
- сигнал о том, что строка содержит лишние, неучтённые или новые элементы;
- может использоваться для отбраковки или для последующей ручной проверки.

---

## 200 — INTERNAL_ERROR

**Описание:**  
Внутренняя ошибка парсера.

**Примеры:**
- ошибка в логике обработки массивов Param*;
- выход за пределы индексов;
- критическая ошибка в регулярном выражении;
- недопустимая комбинация состояний.

**Рекомендация:**
- использовать только для действительно неожиданных ситуаций;
- при отладке желательно по возможности заменять INTERNAL_ERROR на более конкретные коды (2, 4, 5, 6, 7, 127), если причина ясна.

---

## Рекомендации по использованию кодов

1. Каждая функция P_XXX:
   - должна в начале устанавливать `ParamErrorCode(i) = 0`;
   - по результату:
     - при успехе — вернуть 255,
     - при проблеме — установить соответствующий код и вернуть его.

2. Главная функция PARSER:
   - имеет право остановить дальнейший парсинг при первой критической ошибке (по ТЗ),
   - либо продолжить (режим "собрать максимум информации об ошибках") — этот режим определяется архитектурой проекта.

3. В отладке по Debug.Print рекомендуется выводить:
   - имя параметра,
   - найденное значение,
   - ParamStart/ParamEnd,
   - ParamErrorCode(i),
   - WorkString до и после замены.
