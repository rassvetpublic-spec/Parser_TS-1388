# Grammar for TS-1388 Parser

Документ описывает грамматику строк заказа типа TS-1388, а также общие правила работы парсера TS-1388 Parser.

Парсер реализован на VBA (Excel 2016) русский интерфейс, использует массивы:
- ParamName(1..20)
- ParamValue(1..20)
- ParamStart(1..20)
- ParamEnd(1..20)
- ParamErrorCode(1..20)

И глобальную строку WorkString (нормализованный текст заказа).

Логика пошагового парсинга и порядок вызова функций строго определены ТЗ.  
Содержание параметров (типовые значения, диапазоны, смысл) — ориентировано на форму заказа TS-1388 и реальные примеры строк.

---

## 1. Общая структура строки заказа

Строка заказа представляет собой последовательность параметров, разделённых символом `/` (возможны пробелы вокруг разделителя).

Типичный вид (после нормализации):
[TYPE] ISPOLN / MODEL / AES / EX / SENSOR / T_RANGE / L / D1 / D2 / CABLE / HEAD / MOUNT / PLUG / SCHEME / OPTIONS / TU / CLIMATE

Где:

TYPE — необязательный префикс типа (ТС-1388, TS-1388, TС 1388 и т.п.).

ISPOLN — исполнение (B V3, ExВ G2, АВ V3, BC, Ex, и т.п.).

Далее — параметры в порядке, соответствующем форме заказа (конструктив, класс, EX, НСХ и т.д.).

Важно:
Фактический порядок параметров в строке должен следовать форме заказа.
Однако функции парсера вызываются в порядке, определённом ТЗ:
6, 1, 2, 5, 4, 3, 7, 8, 17, 9, 10, 11, 18, 12, 14, 13, 15, 16, 19, 20
(Номера здесь — внутренние номера параметров по ТЗ, а не позиция в строке.)

2. Нормализация строки

Перед парсингом исходная строка должна быть нормализована функцией NormalizeGOST (в данном проекте — в контексте TS-1388, но имя функции сохраняется).

2.1 Шаги нормализации

Удалить ведущие и хвостовые пробелы.

Заменить длинные тире (—, –) на обычный дефис -.

Заменить все последовательности из двух и более пробелов на один пробел.

Удалить пробелы вокруг разделителя /:

" /" > "/"

"/ " > "/"

Заменить русские буквы, похожие на латинские, на латиницу:

К>K, Е>E, Н>H, Х>X, В>B, А>A, Р>P, О>O, С>C, М>M, Т>T

и соответствующие строчные.

Привести всю строку к верхнему регистру (UCase).

Строка TYPE (ТС1388 / TS-1388 / TС 1388 и варианты с пробелами) приводится к единой форме, например TS1388 либо TS-1388 (конкретная форма задаётся в реализации).

Результат записывается в WorkString.

3 TYPE
Допустимые формы до нормализации:
ТС-1388
ТС1388
TС 1388
TS-1388
TS 1388

варианты с лишними пробелами и тире.

После нормализации:

единый шаблон TS-1388.

Правило:

Если TYPE отсутствует, парсер должен добавить тип по умолчанию (TS-1388) в начало WorkString.

3.2 ISPOLN (исполнение)

Это первый значимый параметр в строке после TYPE (или сразу в начале, если TYPE нет).

Примеры из реальных строк:
-                 (нет исполнения)
B F3
B G2
B V3
BC
EX
EXB F3
EXB G2
EXB V3
EXBC
АВ V3
EXВ V3
EXВС
Особенности:

Возможны комбинации букв: A, B, C, EX, F3, G2, V3, и т.п.

Символ - означает отсутствие исполнения.

Нормализованное значение ISPOLN сохраняется в ParamValue.

4. Параметры строки по позиции (форма заказа)

Ниже описана структура после TYPE (если TYPE есть) или с самого начала (если TYPE нет).
Сегменты разделены /.

Для упрощения обозначим:
ISPOLN / MODEL / AES / EX / SENSOR / SEG6 / SEG7 / SEG8 / SEG9 / ISPOLN0 / ISPOLN1 / ISPOLN2 / ISPOLN3 / ISPOLN4 / ISPOLN5 / ISPOLN6 / ISPOLN7 / ISPOLN8
Единый формат строки (в идеальном случае) соответствует форме заказа.

4.1 ISPOLN (исполнение)

См. выше.
Может быть - или комбинация B V3, EXB G2, АВ V3 и т.п.
После нормализации разбросанные пробелы склеиваются в стандартизованный вид (решение по формату — в коде парсера).

4.2 MODEL (конструктивный номер исполнения)

Примеры значений:
1
3
5
5ШМ
8-1
11
11PLT164
12
13М
21
25-1
3ТКП
1-1М
2-2
2-1
2-3
1-1
Особенности:

Могут быть чистые числа (1, 3, 5, 11, 21).

Могут быть буквенно-цифровые коды (3ТКП, 5ШМ, 13М, 11PLT164, 1-1М, 2-2, 2-1, 2-3, 8-1).

Возможны дефисы и русские буквы (приводятся к латинице там, где это необходимо, либо хранятся как есть, если это часть кода).

Это именно конструктивный номер исполнения по форме заказа.
В парсере этот параметр соответствует P_MODEL.

4.3 AES — класс безопасности для АЭС
По примерам:

-
3Н
2НУ
2
3
4


4.4 EX (взрывозащита)

Примеры:

-
0ЕХ IA IIС T5 GA X
1ЕХ DB IIВ T3 GB X
0ЕХ IA IIВ T4 GA X
0ЕХ DB IIС T5 GB X

Особенности:

Может быть - (нет взрывозащиты).

Может содержать сложный текст с типом, группой, температурным классом.

Парсер должен:

найти фрагмент 0EX…;

склеить все пробелы;

сохранить нормализованное значение в ParamValue.

4.5 SENSOR / НСХ первичного преобразователя

Примеры:

100P
100M
50M
50P
PT100
PT500
PT1000


4.6 температурный диапазон (P_T_LOW / P_T_HIGH)

Формат:

-5,5...+200,7
-196...+500
-60...160
-50...+0
-196...0


Особенности:

Три точки могут быть как ..., так и символ многоточия после нормализации.

Нижняя и верхняя границы включают знак (-50, +200 и т.п.).

Парсер должен выделить отдельно:

T_LOW

T_HIGH

Контроль диапазона — по инженерным правилам (например, T_LOW < T_HIGH, значения в допустимых пределах).

4.7 SEG7, SEG8, SEG9 — геометрия и размеры

Примеры SEG7:

20
30
50
80
100
120
200
2000
250
29
40


Примеры SEG8:

5(М8Х1)
4
6
8
10--->9
3
2


Примеры SEG9:

1,5
1
6
10
4
2
3
5
7
0,15
0,5
15


Общее правило:

SEG7 — длина (мм).

SEG8 — диаметр/тип резьбы/особенность участка (может быть и числом, и строкой вида 5(М8Х1)).

SEG9 — толщина стенки / диаметр / иное размерное значение (в зависимости от исполнения).

Для парсера важно аккуратно:

выделить числовые части (где возможно),

сохранить строку целиком как ParamValue, если формат сложный.

4.8 ISPOLN — тип кабеля / соединительного элемента

Примеры:

КММФЭ
КМНЭ
МС-16-13
-


Здесь указываются:

тип кабеля (КММФЭ, КМНЭ),

тип разъёма (МС-16-13),

либо - (нет кабеля / не используется).

4.9 ISPOLN1 — головка / корпус

Примеры:

B
C
A
-


Обозначает тип головки / корпуса.
Чаще всего B или C.

4.10 ISPOLN2, ISPOLN3 — дополнительные элементы (штекеры, разъёмы и т.п.)

Примеры комбинаций:

- / -
- / MIT8
- / PLT164
- / -
- / -


Интерпретация:

ISPOLN2 может быть - или обозначать промежуточный параметр (вид установки и т.п.).

ISPOLN3 часто — обозначение разъёма: MIT8, PLT164, МС-16-13, или -.

Важно: для парсера эти параметры фиксируются и сохраняются как есть, в соответствии с ТЗ (конкретные названия P_XXX задаются в модуле констант и мэппинге).

4.11 ISPOLN4 — схема подключения / номер схемы

Примеры:

№2
№3
№5


Это номер схемы, как в форме заказа.

4.12 ISPOLN5 — опции / тип исполнения (ГП, др.)

Примеры:

ГП
-


Обычно ГП (горячее исполнение / группа поставки по ТУ), либо -.

4.13 ISPOLN6, ISPOLN7, ISPOLN8 — ТУ, климат, дополнительные опции

Примеры:

- / - / -
ТУ 4211-012-13282997-2014 / - / -
- / УХЛ3.1 / -
ТУ 4211-012-13282997-2014 / - / -


Общая логика:

один из сегментов может содержать ТУ,

один — климатическое исполнение (УХЛ3.1),

остальные могут быть -.

Для парсера:

каждый сегмент — отдельный параметр P_XX;

необходимо хранить значения и при необходимости проверять по whitelist/regexp.

5. Порядок вызова функций парсинга (по ТЗ)

Главная функция PARSER должна вызывать функции парсинга в строгой последовательности:

6, 1, 2, 5, 4, 3, 7, 8, 17, 9, 10, 11, 18, 12, 14, 13, 15, 16, 19, 20


Где:

числа — внутренние номера параметров (индексы в массивах ParamName/ParamValue и т.п.),

порядок — задан ТЗ и не соответствует напрямую позициям ISPOLN..ISPOLN8.

Каждая функция:
работает с WorkString в её текущем состоянии,
при успехе:
находит свой параметр,
заполняет ParamValue/ParamStart/ParamEnd,
вызывает замену фрагмента на токен (см. TokenRules.md),

при ошибке:
устанавливает ParamErrorCode(i),
возвращает код ошибки (см. ErrorCodes.md).

6. Примеры корректных строк

Ниже приведены реальные примеры строк, соответствующих форме заказа и поддерживаемых грамматикой (после нормализации пробелов/букв и т.п.):

-/ 1/ -/ -/ 100П/ -50...+200/ 20/ 5(М8Х1)/ 1,5/ КММФЭ/ C/ -/ -/ №2/ ГП/ -/ -
-/ 11/ -/ -/ PT100/ -196...+500/ 120/ 4/ 6/ КМНЭ/ B/ -/ МИТ8/ №3/ ГП/ -/ -
B V3/ 13М/ -/ -/ PT100/ -60...+160/ 30Х10Х3/ -/ 1/ МС-16-13/ B/ -/ -/ №2/ ГП/ -/ -
ТС1388/B V3/ 2-2/ -/ 100П/ -50...+200/ 30/ 8/ 7/ КММФЭ/ B/ -/ -/ №3/ ГП/ ТУ 4211-012-13282997-2014/ -
EXВ V3/ 13М/ -/ 0ЕХ IA IIВ T4 GA X/ PT100/ -60...+160/ 190Х9Х2/ -/ 0,5/ МС-16-13/ B/ -/ -/ №2/ ГП/ -/ -
АВ V3/ 1-1М/ 2/ -/ PT100/ -60...+160/ 20/ 5/ 1,2/ КММФЭ/ B/ -/ -/ №3/ ГП/ ТУ 4211-012-13282997-2014/ -


Парсер TS-1388 обязан корректно разбирать такие строки, даже если в исходных данных присутствуют:
лишние пробелы, различные варианты написания тире и многоточий.