# Token Rules for TS-1388 Parser

Данный документ описывает правила формирования и применения токенов при разборе строк заказа TS-1388.

Токены используются для:

- замены найденных параметров в WorkString;
- предотвращения повторного захвата тех же фрагментов;
- удобства отладки (легко увидеть, какие параметры уже выделены);
- унификации логики последующей обработки.

---

## 1. Формат токена

Общий формат:


#<номер>_<имя>%

где:

<номер> — индекс параметра (целое число, как правило от 1 до 20), совпадает с индексом в массивах ParamName/ParamValue/ParamStart/ParamEnd/ParamErrorCode;

<имя> — строковое имя параметра, соответствующее ParamName(i).

Примеры:

#1_P_TYPE%
#2_P_ISPOLN%
#3_P_MODEL%
#4_P_KL_AES%
#5_P_EX%
#6_P_SENSOR%
#7_P_T_LOW%
#8_P_T_HIGH%
#9_P_L%
#10_P_D1%
#11_P_D2%
#12_P_KABEL%
#13_P_HEAD%
#14_P_MOUNT%
#15_P_PLUG%
#16_P_SCHEME%
#17_P_OPTIONS%
#18_P_TU%
#19_P_CLIMATE%
#20_P_EXTRA%
(точный список имён задаётся в модуле констант и в ParamName())
2. Жёсткие ограничения

Внутри токена не допускаются пробелы.

Неправильно:

#1_ P_TYPE%
#1_P TYPE%
# 1_P_TYPE %


Правильно:

#1_P_TYPE%

Символы # и % используются только в качестве ограничителей токена.

<имя> должно строго соответствовать ParamName(i):

если ParamName(6) = "P_T_LOW",

токен должен иметь вид #6_P_T_LOW%.

3. Процесс замены фрагмента на токен

При успешном нахождении параметра с индексом i:

Записываются:

ParamStart(i) — позиция первого символа значения в исходной (нормализованной) WorkString (1-based),

ParamEnd(i) — позиция последнего символа значения.

Вычисляются части строки:

leftPart  = Mid$(WorkString, 1, ParamStart(i) - 1)
rightPart = Mid$(WorkString, ParamEnd(i) + 1)


Формируется токен:

newToken = "#" & CStr(i) & "_" & ParamName(i) & "%"


Выполняется замена:

WorkString = leftPart & newToken & rightPart


При необходимости фиксируются длины до и после замены (для отладки).

4. Очистка значения перед заменой

Перед формированием токена выполняется очистка ParamValue(i):

удаление лишних пробелов;

удаление /, если они относились к структуре, а не к содержимому;

удаление скобок, если по ТЗ значение должно быть без них;

нормализация букв (рус/лат) по тем же правилам, что и в NormalizeGOST;

приведение к согласованному формату (например, A EX B G2 > AEXBG2, если это правило принято для P_ISPOLN).

После очистки:

ParamValue(i) хранит уже нормализованное значение параметра;

в WorkString вместо исходного фрагмента стоит токен.

5. Нумерация и соответствие массивам

Для каждого параметра i:

ParamName(i) — логическое имя (например, "P_MODEL"),

ParamValue(i) — найденное значение,

ParamStart(i) / ParamEnd(i) — исходные границы,

ParamErrorCode(i) — результат валидации.

Токен #i_ParamName(i)% является единственно допустимым вариантом токена для данного параметра.

6. Поведение при повторном нахождении параметра

Если функция парсинга обнаруживает, что:

параметр уже имеет токен в WorkString (т.е. WorkString в этой области содержит #i_ParamName(i)%),

или ParamStart/ParamEnd/ParamValue уже заполнены,

то допустимы две стратегии:

Считать повторное нахождение ошибкой и возвращать TOKEN_CONFLICT.

Разрешать перезапись (например, брать последнюю версию значения).

Рекомендуемый для TS-1388 Parser вариант — строгий режим:

если параметр найден повторно в другой части строки — возвращать TOKEN_CONFLICT.
7. Использование токенов при финальной проверке

После выполнения всех функций P_XXX:

WorkString должен состоять из:

набора токенов #i_ParamName(i)%,

разделителей (/, -, пробелы, допустимые запятые),

допускаемых остаточных фрагментов (если они разрешены ТЗ).

Если в WorkString остаются подстроки, не соответствующие ни одному токену и не описанные в Grammar.md, парсер может:

либо вернуть ошибку UNKNOWN_FRAGMENT,

либо записать предупреждение и продолжить (в зависимости от настроек).

8. Связь с ReplaceParam

Функция ReplaceParam(ByVal n As Integer) (или её аналог) должна:

Проверить, что:

n в допустимом диапазоне (1..20),

ParamValue(n) <> "",

ParamStart(n) > 0,

ParamEnd(n) >= ParamStart(n),

ParamErrorCode(n) указывает на то, что параметр найден и требует замены (например, код ERR_FOUND_NOT_CLEANED или 0).

Выполнить очистку значения по ТЗ.

Сформировать токен #n_ParamName(n)%.

Заменить соответствующий фрагмент WorkString на токен.

В случае невыполнения замены установить ParamErrorCode(n) = ERR_FOUND_NOT_CLEANED (3) и вернуть этот код.

9. Отладка и логирование

Рекомендуется для каждого шага:

выводить в Debug.Print:

имя параметра,

исходный фрагмент,

очищенное значение,

токен,

WorkString до/после замены.

Это позволяет по логам однозначно понять:

в каком месте строки был найден параметр,

какое значение он получил,

правильно ли токены встали в WorkString.

