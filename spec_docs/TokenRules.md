# Token Rules for TS-1388 Parser

Данный документ описывает правила формирования и применения токенов при разборе строк заказа TS-1388.
Важно! Очередность поиска каждого токена не линейная! (Задается в Grammar.md)

Токены используются для:

- замены найденных параметров в WorkString;
- предотвращения повторного захвата тех же фрагментов;
- удобства отладки (легко увидеть, какие параметры уже выделены);
- унификации логики последующей обработки.

---

## 1. Формат токена

Общий формат:


#<номер>_<значение>%

где:

<номер> — индекс параметра (целое число, как правило от 1 до 20), совпадает с индексом в массивах ParamName/ParamValue/ParamStart/ParamEnd/ParamErrorCode;

<значение> — строковое значение параметра, соответствующее ParamValue(i).

Пример (в реальной строке другие значения параметров!)
#1_TS-1388%
#2_AExBV3%
#3_1-1M%
#4_3NU%
#5_0ЕхiaIIВT4GaX%
#6_Pt100%
#7_-60%
#8_+200%
#9_60%
#10_5%
#11_M8X1%
#12_1,5%
#13_KMMFE%
#14_B%
#15_-%
#16_MIT8%
#17_N3%
#18_GP%
#19_TU4211-012-13282997-2014%
#20_EXTRA%

2. Жёсткие ограничения

Внутри токена не допускаются пробелы.

Неправильно:
#1_TS 1388%
# 1_TS-1388 %

Правильно:
#1_TS-1388%

Символы # и % используются только в качестве ограничителей токена.

3. Процесс замены фрагмента на токен
При успешном нахождении параметра с индексом i:
Записываются:
ParamStart(i) — позиция первого символа значения в WorkString (1-based),
ParamEnd(i) — позиция последнего символа значения.

Вычисляются части строки:
leftPart  = Mid$(WorkString, 1, ParamStart(i) - 1)
rightPart = Mid$(WorkString, ParamEnd(i) + 1)

Формируется токен:
newToken = "#" & CStr(i) & "_" & ParamValue(i) & "%"

Выполняется замена:
WorkString = leftPart & newToken & rightPart

4. Очистка значения перед заменой
Перед формированием токена выполняется очистка ParamValue(i):
удаление лишних пробелов;
удаление /, если они относились к структуре, а не к содержимому;
удаление скобок;

После очистки:
ParamValue(i) хранит уже нормализованное значение параметра;
в WorkString вместо исходного фрагмента стоит токен.

5. Нумерация и соответствие массивам
Для каждого параметра i:
ParamName(i) — логическое имя (например, "MODEL"),
ParamValue(i) — найденное значение,
ParamStart(i) / ParamEnd(i) — исходные границы,
ParamErrorCode(i) — результат валидации.

7. Использование токенов при финальной проверке
После выполнения всех функций P_XXX:

WorkString должен состоять из:

набора токенов #i_ParamValue(i)%#i_ParamValue(i+1)%#i_ParamValue(i+n)%


Если в WorkString остаются подстроки, не соответствующие ни одному токену и не описанные в Grammar.md, парсер вернуть ошибку UNKNOWN_FRAGMENT.

8. Связь с ReplaceParam

Функция ReplaceParam(ByVal n As Integer) должна:

Проверить, что:
n в допустимом диапазоне (1..20),
ParamValue(n) <> "",
ParamStart(n) > 0,
ParamEnd(n) >= ParamStart(n),
ParamErrorCode(n) указывает на то, что параметр найден и требует замены (например, код ERR_FOUND_NOT_CLEANED или 255).
Выполнить очистку значения от "мусора".
Сформировать токен #i_ParamValue(i)%.
Заменить соответствующий фрагмент WorkString на токен.
В случае невыполнения замены установить ParamErrorCode(n) = ERR_FOUND_NOT_CLEANED (3) и вернуть этот код.

9. Отладка и логирование
Рекомендуется для каждого шага:
выводить в Debug.Print:
имя параметра,
исходный фрагмент,
очищенное значение,
токен,
WorkString до/после замены.
Это позволяет по логам однозначно понять:
в каком месте строки был найден параметр,
какое значение он получил,
правильно ли токены встали в WorkString.